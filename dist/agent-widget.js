!function(e,n){"object"==typeof exports&&"object"==typeof module?module.exports=n():"function"==typeof define&&define.amd?define([],n):"object"==typeof exports?exports.VoiceAgentSDK=n():e.VoiceAgentSDK=n()}(this,()=>(()=>{"use strict";var e={d:(n,t)=>{for(var i in t)e.o(t,i)&&!e.o(n,i)&&Object.defineProperty(n,i,{enumerable:!0,get:t[i]})},o:(e,n)=>Object.prototype.hasOwnProperty.call(e,n)},n={};e.d(n,{default:()=>s});class t{constructor(e){this.config=e,this.ws=null,this.isConnected=!1,this.isListening=!1,this.mediaRecorder=null,this.audioContext=null,this.audioQueue=[],this.isPlaying=!1,this.onConnected=()=>{},this.onDisconnected=()=>{},this.onError=e=>console.error("SDK Error:",e),this.onTranscript=e=>{},this.onAgentSpeaking=e=>{}}async connect(e){try{if(!e)throw new Error("signedUrl is required");this.ws=new WebSocket(e),this.ws.onopen=()=>{console.log("WebSocket connected")},this.ws.onmessage=e=>{try{const n=JSON.parse(e.data);this.handleWebSocketMessage(n)}catch(n){console.log("Received non-JSON message (testing mode):",e.data)}},this.ws.onerror=e=>{this.onError(e)},this.ws.onclose=()=>{this.isConnected=!1,this.onDisconnected()},await this.waitForConnection(),this.isConnected=!0,this.onConnected()}catch(e){throw this.onError(e),e}}waitForConnection(){return new Promise((e,n)=>{const t=setTimeout(()=>{n(new Error("Connection timeout"))},1e4);this.ws.addEventListener("open",()=>{this.ws.readyState===WebSocket.OPEN&&(clearTimeout(t),e())})})}handleWebSocketMessage(e){switch(e.type){case"connected":console.log("Session started successfully");break;case"transcript":this.onTranscript(e.text);break;case"agent_audio":this.playAudio(e.audio);break;case"agent_speaking_start":this.onAgentSpeaking(!0);break;case"agent_speaking_end":this.onAgentSpeaking(!1);break;case"error":this.onError(new Error(e.message))}}async startListening(){try{const e=await navigator.mediaDevices.getUserMedia({audio:!0});this.mediaRecorder=new MediaRecorder(e,{mimeType:"audio/webm;codecs=opus"}),this.mediaRecorder.ondataavailable=e=>{e.data.size>0&&this.ws.readyState===WebSocket.OPEN&&this.sendAudioChunk(e.data)},this.mediaRecorder.start(100),this.isListening=!0}catch(e){throw this.onError(new Error("Microphone access denied")),e}}async sendAudioChunk(e){const n=new FileReader;n.onloadend=()=>{const e=n.result.split(",")[1];this.ws.send(JSON.stringify({type:"audio",audio:e}))},n.readAsDataURL(e)}stopListening(){this.mediaRecorder&&this.isListening&&(this.mediaRecorder.stop(),this.mediaRecorder.stream.getTracks().forEach(e=>e.stop()),this.isListening=!1)}async playAudio(e){this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext));const n=atob(e),t=new ArrayBuffer(n.length),i=new Uint8Array(t);for(let e=0;e<n.length;e++)i[e]=n.charCodeAt(e);try{const e=await this.audioContext.decodeAudioData(t);this.audioQueue.push(e),this.isPlaying||this.playNextInQueue()}catch(e){console.error("Error decoding audio:",e)}}playNextInQueue(){if(0===this.audioQueue.length)return void(this.isPlaying=!1);this.isPlaying=!0;const e=this.audioQueue.shift(),n=this.audioContext.createBufferSource();n.buffer=e,n.connect(this.audioContext.destination),n.onended=()=>{this.playNextInQueue()},n.start(0)}updateVariables(e){this.ws&&this.isConnected&&this.ws.send(JSON.stringify({type:"update_variables",variables:e}))}disconnect(){this.stopListening(),this.ws&&this.ws.close(),this.audioContext&&this.audioContext.close()}}class i{constructor(e){this.config=e,this.sdk=new t,this.isOpen=!1,this.isActive=!1,this.position=e.position||"bottom-right",this.primaryColor=e.primaryColor||"#4F46E5",this.setupEventHandlers(),this.createWidget()}setupEventHandlers(){this.sdk.onConnected=()=>{this.updateStatus("connected")},this.sdk.onDisconnected=()=>{this.updateStatus("disconnected"),this.isActive=!1},this.sdk.onError=e=>{this.showError(e.message)},this.sdk.onTranscript=e=>{this.addMessage("user",e)},this.sdk.onAgentSpeaking=e=>{e?this.showAgentThinking():this.hideAgentThinking()}}createWidget(){const e=document.createElement("div");e.id="agent-widget",e.innerHTML=`\n      <style>\n        #agent-widget {\n          position: fixed;\n          ${this.position.includes("bottom")?"bottom: 20px;":"top: 20px;"}\n          ${this.position.includes("right")?"right: 20px;":"left: 20px;"}\n          z-index: 9999;\n          font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;\n        }\n        \n        #agent-button {\n          width: 60px;\n          height: 60px;\n          border-radius: 50%;\n          background: ${this.primaryColor};\n          border: none;\n          cursor: pointer;\n          box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          transition: transform 0.2s;\n        }\n        \n        #agent-button:hover {\n          transform: scale(1.1);\n        }\n        \n        #agent-button svg {\n          width: 28px;\n          height: 28px;\n          fill: white;\n        }\n        \n        #agent-panel {\n          display: none;\n          position: absolute;\n          bottom: 80px;\n          ${this.position.includes("right")?"right: 0;":"left: 0;"}\n          width: 350px;\n          height: 500px;\n          background: white;\n          border-radius: 12px;\n          box-shadow: 0 8px 32px rgba(0,0,0,0.2);\n          flex-direction: column;\n          overflow: hidden;\n        }\n        \n        #agent-panel.open {\n          display: flex;\n        }\n        \n        #agent-header {\n          background: ${this.primaryColor};\n          color: white;\n          padding: 16px;\n          display: flex;\n          justify-content: space-between;\n          align-items: center;\n        }\n        \n        #agent-close {\n          background: none;\n          border: none;\n          color: white;\n          cursor: pointer;\n          font-size: 24px;\n        }\n        \n        #agent-messages {\n          flex: 1;\n          overflow-y: auto;\n          padding: 16px;\n          display: flex;\n          flex-direction: column;\n          gap: 12px;\n        }\n        \n        .message {\n          padding: 12px;\n          border-radius: 8px;\n          max-width: 80%;\n        }\n        \n        .message.user {\n          background: #E5E7EB;\n          align-self: flex-end;\n        }\n        \n        .message.agent {\n          background: #F3F4F6;\n          align-self: flex-start;\n        }\n        \n        #agent-controls {\n          padding: 16px;\n          border-top: 1px solid #E5E7EB;\n          display: flex;\n          justify-content: center;\n        }\n        \n        #agent-mic-button {\n          width: 60px;\n          height: 60px;\n          border-radius: 50%;\n          border: none;\n          background: ${this.primaryColor};\n          cursor: pointer;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          transition: all 0.2s;\n        }\n        \n        #agent-mic-button.active {\n          background: #EF4444;\n          animation: pulse 1.5s infinite;\n        }\n        \n        #agent-mic-button svg {\n          width: 28px;\n          height: 28px;\n          fill: white;\n        }\n        \n        @keyframes pulse {\n          0%, 100% { transform: scale(1); }\n          50% { transform: scale(1.05); }\n        }\n        \n        .agent-thinking {\n          font-style: italic;\n          color: #6B7280;\n        }\n        \n        .error-message {\n          background: #FEE2E2;\n          color: #991B1B;\n          padding: 12px;\n          border-radius: 8px;\n          margin: 8px;\n        }\n      </style>\n      \n      <button id="agent-button">\n        <svg viewBox="0 0 24 24">\n          <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>\n          <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>\n        </svg>\n      </button>\n      \n      <div id="agent-panel">\n        <div id="agent-header">\n          <h3 style="margin: 0;">Voice Assistant</h3>\n          <button id="agent-close">&times;</button>\n        </div>\n        \n        <div id="agent-messages"></div>\n        \n        <div id="agent-controls">\n          <button id="agent-mic-button">\n            <svg viewBox="0 0 24 24">\n              <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>\n              <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>\n            </svg>\n          </button>\n        </div>\n      </div>\n    `,document.body.appendChild(e),document.getElementById("agent-button").onclick=()=>this.togglePanel(),document.getElementById("agent-close").onclick=()=>this.togglePanel(),document.getElementById("agent-mic-button").onclick=()=>this.toggleVoice()}togglePanel(){this.isOpen=!this.isOpen,document.getElementById("agent-panel").classList.toggle("open")}async toggleVoice(){if(this.isActive)this.sdk.stopListening(),this.sdk.disconnect(),this.isActive=!1,document.getElementById("agent-mic-button").classList.remove("active");else try{const e=await this.getSignedUrl();await this.sdk.connect(e),await this.sdk.startListening(),this.isActive=!0,document.getElementById("agent-mic-button").classList.add("active"),this.addMessage("system","Listening...")}catch(e){console.error("Failed to start:",e),this.showError(e.message)}}async getSignedUrl(){if("string"==typeof this.config.getSessionUrl){const e=await fetch(this.config.getSessionUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({agentId:this.config.agentId,variables:this.config.variables||{}})});if(!e.ok)throw new Error(`Failed to get session URL: ${e.statusText}`);const n=await e.json();return n.signedUrl||n.wsUrl||n.url}if("function"==typeof this.config.getSessionUrl){const e=await this.config.getSessionUrl({agentId:this.config.agentId,variables:this.config.variables||{}});return"string"==typeof e?e:e.signedUrl||e.wsUrl||e.url}throw new Error("getSessionUrl is required (URL string or function)")}addMessage(e,n){const t=document.getElementById("agent-messages"),i=document.createElement("div");i.className=`message ${e}`,i.textContent=n,t.appendChild(i),t.scrollTop=t.scrollHeight}showAgentThinking(){const e=document.getElementById("agent-messages"),n=document.createElement("div");n.className="message agent agent-thinking",n.id="thinking-indicator",n.textContent="Agent is speaking...",e.appendChild(n),e.scrollTop=e.scrollHeight}hideAgentThinking(){const e=document.getElementById("thinking-indicator");e&&e.remove()}showError(e){const n=document.getElementById("agent-messages"),t=document.createElement("div");t.className="error-message",t.textContent=e,n.appendChild(t)}updateStatus(e){console.log("Widget status:",e)}}"undefined"!=typeof window&&(window.AgentWidget={init:e=>{if(!e.agentId)throw new Error("agentId is required");if(!e.getSessionUrl)throw new Error("getSessionUrl is required");return new i(e)}},window.AgentSDK=t);const s={AgentSDK:t,AgentWidget:i};return n.default})());
//# sourceMappingURL=agent-widget.js.map